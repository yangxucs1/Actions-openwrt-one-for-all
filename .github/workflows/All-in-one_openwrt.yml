#
# Description: Build OpenWrt using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: å¤šç‰ˆæœ¬ OpenWRT æ„å»º

permissions: write-all
  # å¼€å¯å†™æƒé™ï¼Œé˜²æ­¢æ— æ³•ä¸Šä¼ åˆ°release

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      enable_ssh:           
        # å‚æ•°åç§°ï¼Œç”¨äºåœ¨å·¥ä½œæµä¸­å¼•ç”¨
        description: "å¯ç”¨SSHè°ƒè¯• (true/false)"
          # æè¿°ä¿¡æ¯ï¼Œæ˜¾ç¤ºåœ¨æ‰‹åŠ¨è§¦å‘ç•Œé¢
        required: true
          # æ˜¯/å¦ä¸ºå¿…å¡«é¡¹ï¼ˆtrue/falseï¼‰
        default: "false"
          # é»˜è®¤ä¸å¼€å¯SSHï¼Œå¦‚éœ€å¼€å¯SSHè¿æ¥ï¼Œåœ¨Run Workflowæ—¶æŠŠSSH connection to Actionsçš„å€¼æ”¹ä¸ºtrue
        type: choice
          # è¾“å…¥ç±»å‹ä¸ºä¸‹æ‹‰é€‰æ‹©æ¡†
        options:
          # ä¸‹æ‹‰æ¡†é€‰åˆ™å†…å®¹
          - "true"
            # å¼€å¯SSHè°ƒè¯•
          - "false"
            # å…³é—­SSHè°ƒè¯•
      action:
        description: "æ“ä½œç±»å‹ (build: æ­£å¸¸æ„å»º, build-nocache: æ¸…ç†ç¼“å­˜æ„å»º)"
        required: true
        default: "build"
        type: choice
        options:
          - build
          - build-nocache

  #schedule:
      #å®šæ—¶è§¦å‘ï¼ˆå½“å‰å·²æ³¨é‡Šæ‰ï¼Œéœ€å¯ç”¨å¯åˆ é™¤#ï¼‰
  #  - cron: 0 20 * * 4     
      #      åˆ†,æ—¶,æ—¥,æœˆ,å‘¨ã€‚æ¯å‘¨äº” 20æ—¶æ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´)

env:
  # å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œä¿®æ”¹æ—¶éœ€è¦æ³¨æ„:(å†’å·)åé¢æœ‰ç©ºæ ¼
  ENV_SH: scripts/environment.sh
    # å®‰è£…ç¼–è¯‘ä¾èµ–å·¥å…·è„šæœ¬
  PACKAGES_SH: scripts/packages.sh
    # æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶ä»“åº“è„šæœ¬
  SETTINGS_SH: scripts/init-settings.sh
    #è‡ªå®šä¹‰é…ç½®(æ”¹ipï¼Œæ”¹å¯†ç ç­‰ï¼‰
  CLASH_CORE_SH: scripts/preset-clash-core-amd64.sh
  UPLOAD_BIN_DIR: true
    # æ˜¯å¦ä¸Šä¼ binç›®å½•(true/false)
  UPLOAD_DL_DIR: true
    # æ˜¯å¦ä¸Šä¼ dlç›®å½•(true/false)
  UPLOAD_CONFIG_DIR: true
    # æ˜¯å¦ä¸Šä¼ .configç›®å½•(true/false)
  UPLOAD_FIRMWARE: true
    # æ˜¯å¦ä¸Šä¼ æœ€ç»ˆå›ºä»¶(true/false)
  UPLOAD_RELEASE: true
    # æ˜¯å¦å°†å›ºä»¶å‘å¸ƒä¸ºRelease(true/false)
  TZ: Asia/Shanghai
    # è®¾ç½®æ—¶åŒº

jobs:
  build:
    name: æ„å»º ${{ matrix.version }} - ${{ matrix.target }}
    runs-on: ubuntu-latest
      # è™šæ‹Ÿæœºè¿è¡Œç¯å¢ƒï¼Œå¦‚ï¼šubuntu-24.04
    if: github.event.repository.owner.id == github.event.sender.id
    strategy:
      fail-fast: false  # ä¸€ä¸ªç»„åˆå¤±è´¥ä¸å½±å“å…¶ä»–ç»„åˆ
      matrix:
        version: [ "Lean", "Lienol", "immortalwrt" ]
          # ç‰ˆæœ¬ç»´åº¦ï¼šä¸‰ç§ä¸åŒçš„OpenWRTåˆ†æ”¯
        target: [ "X86-64", "Newifi3-D2" ]
          # ç›®æ ‡è®¾å¤‡ç»´åº¦ï¼šå…±æœ‰3*2,6ç§ç»„åˆ
        include:
          - version: Lean
            repo_url: https://github.com/coolsnowwolf/lede.git
            branch: master
          - version: Lienol
            repo_url: https://github.com/Lienol/openwrt.git
            branch: main
          - version: immortalwrt
            repo_url: https://github.com/immortalwrt/immortalwrt.git
            branch: master

    steps:
      - name: å‡†å¤‡
        uses: actions/checkout@main

      - name: æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        id: check_config
        run: |
          CONFIG_FILE="configs/${{ matrix.version }}/${{ matrix.target }}.config"
            # .configæ–‡ä»¶åä¸ ${{ matrix.target }} å†…å®¹ä¸€è‡´ï¼Œå¦‚ï¼šx86-64.config
            # æ–‡ä»¶è·¯å¾„ä¸º configs/${{ matrix.version }} ,å¦‚ï¼šconfigs/Lean/
            # æ–‡ä»¶å®Œæ•´å­˜æ”¾è·¯å¾„åº”ä¸ºï¼šconfigs/Lean/x86-64.config æˆ– configs/Lienol/Newifi3-D2
            # æ–‡ä»¶åç§°ä¸è¦å«â€œ/â€ï¼Œå¦‚ï¼šæ–‡ä»¶åä¸èƒ½ä¸º â€œx86/64.configâ€ï¼Œè€Œåº”å­˜ä¸ºâ€œx86-64.configâ€
            # æ³¨æ„å¤§å°å†™ï¼

          if [ -f "$CONFIG_FILE" ]; then
            echo "é…ç½®æ–‡ä»¶å­˜åœ¨: $CONFIG_FILE"
            echo "config_exists=true" >> $GITHUB_OUTPUT
          else
            echo "é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼Œç»ˆæ­¢æµç¨‹!"
            echo "config_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: ç»ˆæ­¢ä¸å­˜åœ¨é…ç½®æ–‡ä»¶çš„æµç¨‹
        if: steps.check_config.outputs.config_exists == 'false'
        run: |
          echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»ˆæ­¢å·¥ä½œæµ"
          exit 1

      - name: æ¸…ç†ç£ç›˜ç©ºé—´(Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
            # å¦‚æœè®¾ç½®ä¸º"true"ï¼Œè™½ç„¶å¯ä»¥é‡Šæ”¾çº¦6 GBçš„ç©ºé—´ï¼Œä½†è¿™å¯èƒ½ä¼šåˆ é™¤å®é™…éœ€è¦çš„å·¥å…·
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
            # æ‰€æœ‰è¿™äº›é€‰é¡¹éƒ½é»˜è®¤ä¸º"true"ï¼Œä½†ä½ å¯ä»¥æ ¹æ®å·¥ä½œæµç¨‹çš„éœ€è¦ï¼Œéšæ—¶å°†å…¶è®¾ç½®ä¸º false

      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
          # ç¦ç”¨äº¤äº’å¼æç¤ºï¼Œè½¯ä»¶åŒ…å®‰è£…è¿‡ç¨‹ä½¿ç”¨é»˜è®¤é…ç½®
        run: |
          sudo -E apt-get -qq update -y
          sudo -E apt-get -qq full-upgrade -y
          chmod +x $ENV_SH && $ENV_SH
            # èµ‹äºˆè„šæœ¬å¯æ‰§è¡Œæƒé™å¹¶è¿è¡Œè¯¥è„šæœ¬
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -a -f
          sudo docker container prune -f
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
            # åˆ›å»ºå·¥ä½œç›®å½•
          sudo chown $USER:$GROUPS /workdir
            # è®¾ç½®ç›®å½•æƒé™ä»é»˜è®¤çš„ root æ”¹ä¸ºå½“å‰ç”¨æˆ·

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: å…‹éš†æºä»£ç 
        working-directory: /workdir
        if: steps.check_config.outputs.config_exists == 'true'  # é…ç½®æ–‡ä»¶æ£€æŸ¥åŒé‡ä¿é™©
        run: |
          echo "ä» ${{ matrix.version }} å…‹éš† ${{ matrix.branch }}  åˆ†æ”¯..."
          git clone --depth=1 -b ${{ matrix.branch }} ${{ matrix.repo_url }} openwrt
            # å…‹éš†æºç ä»“åº“
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
            # åˆ›å»ºè½¯é“¾æ¥

      - name: è®¾ç½®ç‰ˆæœ¬ç¯å¢ƒå˜é‡
        run: |
          # ä»ç‰ˆæœ¬åç§°ä¸­æå–ç‰ˆæœ¬ä¿¡æ¯
            if [ "${{ matrix.version }}" = "Lean" ]; then
              echo "VERSION=lede-master" >> $GITHUB_ENV
            elif [ "${{ matrix.version }}" = "Lienol" ]; then
              echo "VERSION=lienol-24.10" >> $GITHUB_ENV
            elif [ "${{ matrix.version }}" = "immortalwrt" ]; then
              echo "VERSION=immortalwrt-master" >> $GITHUB_ENV
            fi

      - name: æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶ä»“åº“
        run: |
          cd openwrt
          chmod +x $GITHUB_WORKSPACE/$PACKAGES_SH && $GITHUB_WORKSPACE/$PACKAGES_SH        

      - name: æ›´æ–° feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a

      - name: å®‰è£…è½¯ä»¶åŒ…å‰åˆ é™¤å¯èƒ½å†²çªçš„æ’ä»¶
        run: |
          cd openwrt
          rm -rf feeds/smpackage/{base-files,dnsmasq,firewall*,fullconenat,libnftnl,nftables,ppp,opkg,ucl,upx,vsftpd*,miniupnpd-iptables,wireless-regdb}

      - name: å®‰è£… feeds è½¯ä»¶åŒ…
        run: |
          cd openwrt
          ./scripts/feeds install -a

      - name: æ‰§è¡Œè‡ªå®šä¹‰è®¾ç½®ï¼ˆåŠ è‡ªå®šä¹‰é…ç½®ã€æ”¹IPåœ°å€ç­‰ï¼‰
        run: |
          [ -d files ] && mv files openwrt/files || echo "files ç›®å½•ä¸å­˜åœ¨"
            # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
          [ -f $CONFIG_FILE ] && cat $CONFIG_FILE >> openwrt/.config
            # å¤åˆ¶è‡ªå®šä¹‰.configé…ç½®

          cd openwrt
          chmod +x $GITHUB_WORKSPACE/$SETTINGS_SH && $GITHUB_WORKSPACE/$SETTINGS_SH
          chmod +x $GITHUB_WORKSPACE/$CLASH_CORE_SH && $GITHUB_WORKSPACE/$CLASH_CORE_SH

      - name: SSHè¿œç¨‹è¿æ¥æœåŠ¡å™¨åœ¨çº¿é…ç½®å›ºä»¶
        id: ssh
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false
            # å…³é—­æƒé™é™åˆ¶
        if: ${{ github.event.inputs.enable_ssh == 'true' }}
          # ä»…å½“åœ¨Run Workflowæ—¶æŠŠSSH connection to Actionsçš„å€¼æ”¹ä¸º"true"æ—¶æ‰å¼€å¯SSH
          # å½“å‡ºç°ç±»ä¼¼â€œssh Y26QeagDtsPXp2mT6me5cnMRd@nyc1.tmate.ioâ€å­—æ ·æ—¶ï¼Œå¤åˆ¶ SSH è¿æ¥å‘½ä»¤ç²˜è´´åˆ°ç»ˆç«¯å†…æ‰§è¡Œï¼Œæˆ–è€…å¤åˆ¶é“¾æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä½¿ç”¨ç½‘é¡µç»ˆç«¯ã€‚
          # ç„¶åè¾“å…¥ï¼šcd openwrt && make menuconfig
          # å®ŒæˆåæŒ‰Ctrl+Dç»„åˆé”®æˆ–æ‰§è¡Œexitå‘½ä»¤é€€å‡ºï¼Œåç»­ç¼–è¯‘å·¥ä½œå°†è‡ªåŠ¨è¿›è¡Œã€‚

      - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–è½¯ä»¶åŒ…
        id: download-dl
        run: |
          cd openwrt
          make defconfig
          make download -j$(($(nproc)+1))
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          make download -j$(($(nproc)+1))

      - name: å¼€å¯ç¼“å­˜
        uses: stupidloud/cachewrtbuild@main
        with:
          ccache: 'true'
            # å¯ç”¨ ccache ç¼“å­˜
          mixkey: ${{ matrix.target }}
            # å®šä¹‰ç¼“å­˜æ ‡è¯†
          clean: ${{ contains(github.event.action, 'nocache') }}
          prefix: ${{ github.workspace }}/openwrt
            # æŒ‡å®šæºç æ ¹ç›®å½•è·¯å¾„

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "$(($(nproc)+1)) çº¿ç¨‹ç¼–è¯‘"
          if make -j$(($(nproc) + 1)) ; then
            echo "ç¼–è¯‘æˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            if make -j1 V=s ; then
              echo "å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "ç¼–è¯‘å¤±è´¥"
              echo "status=failed" >> $GITHUB_OUTPUT
            fi 
          fi
          
          # ç”Ÿæˆå…ƒæ•°æ®
          make json_overview_image_info
          make checksum
  
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
            # æå–è®¾å¤‡åç§°
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
            # æ·»åŠ æ—¶é—´æˆ³

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: ä¸Šä¼  bin ç›®å½•
          # é€šè¿‡ç¯å¢ƒå˜é‡å¤„çš„ "UPLOAD_BIN_DIR: " çš„å€¼æ§åˆ¶(true/false)
        uses: actions/upload-artifact@main
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin

      - name: ä¸Šä¼  dl ç›®å½•
          # é€šè¿‡ç¯å¢ƒå˜é‡å¤„çš„ "UPLOAD_DL_DIR: " çš„å€¼æ§åˆ¶(true/false)
        uses: actions/upload-artifact@main
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_DL_DIR == 'true'
        with:
          name: OpenWrt_dl${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/dl

      - name: ä¸Šä¼  config é…ç½®æ–‡ä»¶
          # é€šè¿‡ç¯å¢ƒå˜é‡å¤„çš„ "UPLOAD_config_DIR: " çš„å€¼æ§åˆ¶(true/false)
        uses: actions/upload-artifact@main
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_CONFIG_DIR == 'true'
        with:
          name: OpenWrt_config${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/.config

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶å¤¹
        working-directory: /workdir
        id: organize
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          mkdir -p firmware
            # åˆ›å»ºå›ºä»¶å­˜æ”¾ç›®å½•
          cd openwrt/bin/targets/*/*
            # è¿›å…¥å›ºä»¶è¾“å‡ºç›®å½•
          TARGET_PLATFORM=$(basename $(dirname $(pwd)))
            # æå–ç›®æ ‡å¹³å°ä¿¡æ¯
          echo "å½“å‰ç›®æ ‡å¹³å°: $TARGET_PLATFORM"     
          shopt -s nullglob
            # å¯ç”¨shellçš„nullglobé€‰é¡¹
          
          if [[ "$TARGET_PLATFORM" == "x86" ]]; then
            for file in *combined* *sysupgrade*; do
            [ -f "$file" ] && mv "$file" /workdir/firmware
            done
              # X86å¹³å°ï¼šä¿å­˜æ–‡ä»¶åä¸­åŒ…å« combined æˆ– sysupgrade çš„æ–‡ä»¶
          else
            for file in *squashfs*.bin; do
            [ -f "$file" ] && mv "$file" /workdir/firmware
              # å…¶ä»–å¹³å°ï¼šåªä¿å­˜sysupgrade.binåŠfactory.binæ ¼å¼
            done
          fi
          
          cd /workdir/firmware
          echo -e "\næ–‡ä»¶MD5æ ¡éªŒå’Œ:" >> build-info.txt
            # æ·»åŠ MD5æ ¡éªŒå’Œ
          for file in *; do
            if [ -f "$file" ]; then  # åªå¤„ç†æ–‡ä»¶ï¼Œæ’é™¤ç›®å½•
              md5=$(md5sum "$file" | awk '{print $1}')
              echo "$md5  $file" >> build-info.txt
            fi
          done
          
          #å¤åˆ¶é…ç½®æ–‡ä»¶
          cp /workdir/openwrt/.config  ./${{matrix.target}}.config 2>/dev/null || true
          cp openwrt/build_dir/target-*/linux-*/linux-*/.config ./${{matrix.target}}_kernel.config 2>/dev/null || true
          #æ·»åŠ ç‰ˆæœ¬ã€è®¾å¤‡ã€æ„å»ºæ—¶é—´ä¿¡æ¯
          CONTENT=$(printf "ç‰ˆæœ¬: ${{ matrix.version }}\nç›®æ ‡è®¾å¤‡: ${{ matrix.target }}\næ„å»ºæ—¶é—´: $(date)\n")
          printf "%b\n" "$CONTENT" "$(cat build-info.txt)" > build-info.txt
          
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
            #å°†å½“å‰ç›®å½•ï¼ˆå›ºä»¶å­˜æ”¾ç›®å½•ï¼‰è·¯å¾„å†™å…¥ç¯å¢ƒå˜é‡FIRMWARE
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: firmware-${{ matrix.version }}_${{ matrix.target }}_${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: ä¿å­˜ç‰ˆæœ¬å’Œç›®æ ‡ä¿¡æ¯
        if: steps.organize.outputs.status == 'success'
        run: |
          echo "${{ matrix.version }}:${{ env.DEVICE_NAME }}" >> version_target_${{ matrix.version }}_${{ env.DEVICE_NAME }}.txt
        working-directory: /workdir

      - name: ä¸Šä¼ ç‰ˆæœ¬ä¿¡æ¯
        uses: actions/upload-artifact@v4
        with:
          name: version_info_${{ matrix.version }}_${{ env.DEVICE_NAME }}
          path: /workdir/version_target.txt

      - name: è®¾ç½®ä½œä¸šè¾“å‡º
        id: set-outputs
        run: |
          echo "upload_release=${{ env.UPLOAD_RELEASE }}" >> $GITHUB_OUTPUT

  release-all:
    name: åˆå¹¶å‘å¸ƒæ‰€æœ‰å›ºä»¶
    runs-on: ubuntu-latest
    needs: build
    if: |
      ${{ 
        always() && 
        !cancelled() && 
        contains(join(needs.build.*.result, ','), 'success')  && 
        needs.build.outputs.upload_release == 'true' 
      }}

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@main
        with:
          path: all-firmwares
          merge-multiple: true

      - name: ä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯
        uses: actions/download-artifact@v4
        with:
          path: version-info
          pattern: version_info_*
          merge-multiple: true

      - name: æå–ç‰ˆæœ¬å’Œç›®æ ‡ä¿¡æ¯
        id: version-info
        run: |
          VERSIONS=()
          TARGETS=()
          
          if [ -f version-info/version_target.txt ]; then
            while IFS= read -r line; do
              IFS=':' read -ra parts <<< "$line"
              VERSIONS+=("${parts[0]}")
              TARGETS+=("${parts[1]}")
            done < version-info/version_target.txt
          fi

          UNIQUE_VERSIONS=($(printf "%s\n" "${VERSIONS[@]}" | sort -u))
          UNIQUE_TARGETS=($(printf "%s\n" "${TARGETS[@]}" | sort -u))
            # å»é‡
          echo "versions=${UNIQUE_VERSIONS[*]}" >> $GITHUB_OUTPUT
          echo "targets=${UNIQUE_TARGETS[*]}" >> $GITHUB_OUTPUT

      - name: æ•´ç†åˆå¹¶å›ºä»¶
        run: |
          mkdir -p final-release
          find all-firmwares -type f -exec cp {} final-release/ \;
            # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°ç»Ÿä¸€ç›®å½•  
          echo "# OpenWRT å›ºä»¶æ±‡æ€»å‘å¸ƒ" > release.txt
          echo "å‘å¸ƒæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> release.txt
          echo "åŒ…å«ä»¥ä¸‹ç‰ˆæœ¬å’Œè®¾å¤‡çš„å›ºä»¶ï¼š" >> release.txt
          echo "- ç‰ˆæœ¬: ${{ steps.version-info.outputs.versions }}" >> release.txt
          echo "- è®¾å¤‡: ${{ steps.version-info.outputs.targets }}" >> release.txt
          echo -e "\nå„å›ºä»¶è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹å¯¹åº” build-info-*.txt æ–‡ä»¶" >> release.txt
          echo -e "\nğŸŒ é»˜è®¤ç®¡ç†IP: 192.168.123.1" >> release.txt

      - name: ç”Ÿæˆç»Ÿä¸€å‘å¸ƒæ ‡ç­¾
        id: tag
        run: |
          echo "release_tag=openwrt-all-firmwares_$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒåˆå¹¶åçš„Release
        uses: softprops/action-gh-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: final-release/*

      - name: ä¿ç•™æœ€æ–°3ä¸ªRelease
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ é™¤æ—§çš„å·¥ä½œæµç¨‹
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 3
