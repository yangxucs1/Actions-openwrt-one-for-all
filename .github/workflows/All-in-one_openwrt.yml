#
# Description: Build OpenWrt using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: å¤šç‰ˆæœ¬ OpenWRT æ„å»º

permissions: write-all
  # å¼€å¯å†™æƒé™ï¼Œé˜²æ­¢æ— æ³•ä¸Šä¼ åˆ°release

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      enable_ssh:           
        # å‚æ•°åç§°ï¼Œç”¨äºåœ¨å·¥ä½œæµä¸­å¼•ç”¨
        description: "å¯ç”¨SSHè°ƒè¯• (true/false)"
          # æè¿°ä¿¡æ¯ï¼Œæ˜¾ç¤ºåœ¨æ‰‹åŠ¨è§¦å‘ç•Œé¢
        required: true
          # æ˜¯/å¦ä¸ºå¿…å¡«é¡¹ï¼ˆtrue/falseï¼‰
        default: "false"
          # é»˜è®¤ä¸å¼€å¯SSHï¼Œå¦‚éœ€å¼€å¯SSHè¿æ¥ï¼Œåœ¨Run Workflowæ—¶æŠŠSSH connection to Actionsçš„å€¼æ”¹ä¸ºtrue
        type: choice
          # è¾“å…¥ç±»å‹ä¸ºä¸‹æ‹‰é€‰æ‹©æ¡†
        options:
          # ä¸‹æ‹‰æ¡†é€‰åˆ™å†…å®¹
          - "true"
            # å¼€å¯SSHè°ƒè¯•
          - "false"
            # å…³é—­SSHè°ƒè¯•
      action:
        description: "æ“ä½œç±»å‹ (build: æ­£å¸¸æ„å»º, build-nocache: æ¸…ç†ç¼“å­˜æ„å»º)"
        required: true
        default: "build"
        type: choice
        options:
          - build
          - build-nocache

  #schedule:
      #å®šæ—¶è§¦å‘ï¼ˆå½“å‰å·²æ³¨é‡Šæ‰ï¼Œéœ€å¯ç”¨å¯åˆ é™¤#ï¼‰
  #  - cron: 0 20 * * 4     
      #      åˆ†,æ—¶,æ—¥,æœˆ,å‘¨ã€‚æ¯å‘¨äº” 20æ—¶æ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´)

env:
  # å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œä¿®æ”¹æ—¶éœ€è¦æ³¨æ„:(å†’å·)åé¢æœ‰ç©ºæ ¼
  ENV_SH: scripts/environment.sh
    # å®‰è£…ç¼–è¯‘ä¾èµ–å·¥å…·è„šæœ¬
  PACKAGES_SH: scripts/packages.sh
    # æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶ä»“åº“è„šæœ¬
  SETTINGS_SH: scripts/init-settings.sh
    #è‡ªå®šä¹‰é…ç½®(æ”¹ipï¼Œæ”¹å¯†ç ç­‰ï¼‰
  CLASH_CORE_SH: scripts/preset-clash-core-amd64.sh
  UPLOAD_BIN_DIR: true
    # æ˜¯å¦ä¸Šä¼ binç›®å½•(true/false)
  UPLOAD_FIRMWARE: true
    # æ˜¯å¦ä¸Šä¼ æœ€ç»ˆå›ºä»¶(true/false)
  UPLOAD_RELEASE: true
    # æ˜¯å¦å°†å›ºä»¶å‘å¸ƒä¸ºRelease(true/false)
  TZ: Asia/Shanghai
    # è®¾ç½®æ—¶åŒº

jobs:
  build:
    name: æ„å»º ${{ matrix.version }} - ${{ matrix.target }}
    runs-on: ubuntu-latest
      # è™šæ‹Ÿæœºè¿è¡Œç¯å¢ƒï¼Œå¦‚ï¼šubuntu-24.04
    if: github.event.repository.owner.id == github.event.sender.id
    strategy:
      fail-fast: false  # ä¸€ä¸ªç»„åˆå¤±è´¥ä¸å½±å“å…¶ä»–ç»„åˆ
      matrix:
        version: [ "Lean", "Lienol", "immortalwrt" ]
          # ç‰ˆæœ¬ç»´åº¦ï¼šä¸‰ç§ä¸åŒçš„OpenWRTåˆ†æ”¯
        target: [ "X86-64", "Newifi3-D2_32M", "TL-WDR7500-V3_16M" ]
          # ç›®æ ‡è®¾å¤‡ç»´åº¦ï¼šä¸‰ç§ä¸åŒçš„è®¾å¤‡
          #å³å…±æœ‰ version * target ç§ç»„åˆ
        include:
          - version: Lean
            repo_url: https://github.com/coolsnowwolf/lede.git
            branch: master
          - version: Lienol
            repo_url: https://github.com/Lienol/openwrt.git
            branch: main
          - version: immortalwrt
            repo_url: https://github.com/immortalwrt/immortalwrt.git
            branch: master

    steps:
      - name: å‡†å¤‡
        uses: actions/checkout@main

      - name: æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        id: check_config
        run: |
          CONFIG_DIR="configs/${{ matrix.version }}"
            # å®šä¹‰é…ç½®æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼ˆç‰ˆæœ¬å¯¹åº”çš„å­ç›®å½•,å¦‚ï¼šconfigs/Leanï¼›configs/Lienolï¼›configs/immortalwrtï¼‰
          TARGET_NAME="${{ matrix.target }}"
            # ç›®æ ‡æ–‡ä»¶åï¼ˆä¸å¸¦åç¼€ï¼Œç”¨äºæ¨¡ç³ŠåŒ¹é…ï¼Œå¦‚ï¼šx86-64, Newifi3-D2ï¼‰
          MATCHED_FILE=$(find "$CONFIG_DIR" -maxdepth 1 -type f -iname "${TARGET_NAME}.config" | head -n 1)
            # ä½¿ç”¨ find å‘½ä»¤åœ¨ CONFIG_DIR ä¸­æœç´¢ä¸ TARGET_NAME å¤§å°å†™æ— å…³çš„ .config æ–‡ä»¶
            # -iname è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™åŒ¹é…ï¼Œ"$TARGET_NAME.config" ä¸ºç›®æ ‡æ–‡ä»¶åæ¨¡å¼ï¼Œå¦‚ï¼šx86-64.configï¼ŒnEWifi3-D2.config
          
            # æ–‡ä»¶å®Œæ•´å­˜æ”¾è·¯å¾„åº”ä¸ºï¼šconfigs/Lean/x86-64.config æˆ– configs/Lienol/Newifi3-D2
            # æ–‡ä»¶åç§°ä¸è¦å«â€œ/â€ï¼Œå¦‚ï¼šæ–‡ä»¶åä¸èƒ½ä¸º â€œx86/64.configâ€ï¼Œè€Œåº”å­˜ä¸ºâ€œx86-64.configâ€

          if [ -f "$MATCHED_FILE" ]; then
            echo "æ‰¾åˆ°åŒ¹é…çš„é…ç½®æ–‡ä»¶: $MATCHED_FILE"
            echo "CONFIG_FILE=$MATCHED_FILE" >> $GITHUB_ENV
              # å°†æ‰¾åˆ°çš„æ–‡ä»¶è·¯å¾„å­˜å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "config_exists=true" >> $GITHUB_OUTPUT
          else
            echo "åœ¨ $CONFIG_DIR ä¸­æœªæ‰¾åˆ°ä¸ ${TARGET_NAME}.config åŒ¹é…çš„æ–‡ä»¶ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰ï¼Œç»ˆæ­¢æµç¨‹!"
            echo "config_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: ç»ˆæ­¢ä¸å­˜åœ¨é…ç½®æ–‡ä»¶çš„æµç¨‹
        if: steps.check_config.outputs.config_exists == 'false'
        run: |
          echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»ˆæ­¢å·¥ä½œæµ"
          exit 1

      - name: æ¸…ç†ç£ç›˜ç©ºé—´(Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
            # å¦‚æœè®¾ç½®ä¸º"true"ï¼Œè™½ç„¶å¯ä»¥é‡Šæ”¾çº¦6 GBçš„ç©ºé—´ï¼Œä½†è¿™å¯èƒ½ä¼šåˆ é™¤å®é™…éœ€è¦çš„å·¥å…·
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
            # æ‰€æœ‰è¿™äº›é€‰é¡¹éƒ½é»˜è®¤ä¸º"true"ï¼Œä½†ä½ å¯ä»¥æ ¹æ®å·¥ä½œæµç¨‹çš„éœ€è¦ï¼Œéšæ—¶å°†å…¶è®¾ç½®ä¸º false

      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
          # ç¦ç”¨äº¤äº’å¼æç¤ºï¼Œè½¯ä»¶åŒ…å®‰è£…è¿‡ç¨‹ä½¿ç”¨é»˜è®¤é…ç½®
        run: |
          sudo -E apt-get -qq update -y
          sudo -E apt-get -qq full-upgrade -y
          chmod +x $ENV_SH && $ENV_SH
            # èµ‹äºˆè„šæœ¬å¯æ‰§è¡Œæƒé™å¹¶è¿è¡Œè¯¥è„šæœ¬
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -a -f
          sudo docker container prune -f
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
            # åˆ›å»ºå·¥ä½œç›®å½•
          sudo chown $USER:$GROUPS /workdir
            # è®¾ç½®ç›®å½•æƒé™ä»é»˜è®¤çš„ root æ”¹ä¸ºå½“å‰ç”¨æˆ·

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: å…‹éš†æºä»£ç 
        working-directory: /workdir
        run: |
          echo "ä» ${{ matrix.version }} å…‹éš† ${{ matrix.branch }}  åˆ†æ”¯..."
          git clone --depth=1 -b ${{ matrix.branch }} ${{ matrix.repo_url }} openwrt
            # å…‹éš†æºç ä»“åº“
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
            # åˆ›å»ºè½¯é“¾æ¥

      - name: è®¾ç½®ç‰ˆæœ¬ç¯å¢ƒå˜é‡
        run: |
          # ä»ç‰ˆæœ¬åç§°ä¸­æå–ç‰ˆæœ¬ä¿¡æ¯
            if [ "${{ matrix.version }}" = "Lean" ]; then
              echo "VERSION=lede-master" >> $GITHUB_ENV
            elif [ "${{ matrix.version }}" = "Lienol" ]; then
              echo "VERSION=lienol-24.10" >> $GITHUB_ENV
            elif [ "${{ matrix.version }}" = "immortalwrt" ]; then
              echo "VERSION=immortalwrt-master" >> $GITHUB_ENV
            fi

      - name: æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶ä»“åº“
        run: |
          cd openwrt
          chmod +x $GITHUB_WORKSPACE/$PACKAGES_SH && $GITHUB_WORKSPACE/$PACKAGES_SH        

      - name: æ›´æ–° feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a

      - name: å®‰è£…è½¯ä»¶åŒ…å‰åˆ é™¤å¯èƒ½å†²çªçš„æ’ä»¶
        run: |
          cd openwrt
          rm -rf feeds/smpackage/{base-files,dnsmasq,firewall*,fullconenat,libnftnl,nftables,ppp,opkg,ucl,upx,vsftpd*,miniupnpd-iptables,wireless-regdb}

      - name: å®‰è£… feeds è½¯ä»¶åŒ…
        run: |
          cd openwrt
          ./scripts/feeds install -a

      - name: æ‰§è¡Œé€šç”¨è„šæœ¬ï¼ˆåŠ è‡ªå®šä¹‰é…ç½®ã€æ”¹IPåœ°å€ç­‰ï¼‰
        run: |
          [ -d files ] && mv files openwrt/files || echo "files ç›®å½•ä¸å­˜åœ¨"
            # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
          [ -f ${{ env.CONFIG_FILE }} ] && cat ${{ env.CONFIG_FILE }} >> openwrt/.config
            # å¤åˆ¶è‡ªå®šä¹‰.configé…ç½®

          cd openwrt
          chmod +x $GITHUB_WORKSPACE/$SETTINGS_SH && $GITHUB_WORKSPACE/$SETTINGS_SH

      - name: æ£€æŸ¥ç›®æ ‡è®¾å¤‡ä¸“ç”¨ .sh è„šæœ¬
        id: check_target_sh
        run: |
          TARGET_NAME="${{ matrix.target }}"
          # åœ¨ scripts ç›®å½•ä¸­æŸ¥æ‰¾ä¸ç›®æ ‡åç§°åŒ¹é…çš„ .sh æ–‡ä»¶ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
          MATCHED_SH_FILE=$(find scripts -maxdepth 1 -type f -iname "*${TARGET_NAME}*.sh" | head -n 1)
          
          if [ -f "$MATCHED_SH_FILE" ]; then
            echo "æ‰¾åˆ°åŒ¹é…çš„ .sh æ–‡ä»¶: $MATCHED_SH_FILE"
            echo "TARGET_SH_FILE=$MATCHED_SH_FILE" >> $GITHUB_ENV
            echo "target_sh_exists=true" >> $GITHUB_OUTPUT
          else
            echo "æœªæ‰¾åˆ°ä¸ ${TARGET_NAME} åŒ¹é…çš„ .sh æ–‡ä»¶"
            echo "target_sh_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: æ‰§è¡Œç›®æ ‡è®¾å¤‡ä¸“ç”¨ .sh è„šæœ¬
        if: steps.check_target_sh.outputs.target_sh_exists == 'true'
        run: |
          echo "æ‰§è¡Œç›®æ ‡è®¾å¤‡ç‰¹å®šçš„è„šæœ¬: ${{ env.TARGET_SH_FILE }}"
          cd openwrt
          chmod +x $GITHUB_WORKSPACE/${{ env.TARGET_SH_FILE }} && $GITHUB_WORKSPACE/${{ env.TARGET_SH_FILE }}

      - name: SSHè¿œç¨‹è¿æ¥æœåŠ¡å™¨åœ¨çº¿é…ç½®å›ºä»¶
        id: ssh
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false
            # å…³é—­æƒé™é™åˆ¶
        if: ${{ github.event.inputs.enable_ssh == 'true' }}
          # ä»…å½“åœ¨Run Workflowæ—¶æŠŠSSH connection to Actionsçš„å€¼æ”¹ä¸º"true"æ—¶æ‰å¼€å¯SSH
          # å½“å‡ºç°ç±»ä¼¼â€œssh Y26QeagDtsPXp2mT6me5cnMRd@nyc1.tmate.ioâ€å­—æ ·æ—¶ï¼Œå¤åˆ¶ SSH è¿æ¥å‘½ä»¤ç²˜è´´åˆ°ç»ˆç«¯å†…æ‰§è¡Œï¼Œæˆ–è€…å¤åˆ¶é“¾æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä½¿ç”¨ç½‘é¡µç»ˆç«¯ã€‚
          # ç„¶åè¾“å…¥ï¼šcd openwrt && make menuconfig
          # å®ŒæˆåæŒ‰Ctrl+Dç»„åˆé”®æˆ–æ‰§è¡Œexitå‘½ä»¤é€€å‡ºï¼Œåç»­ç¼–è¯‘å·¥ä½œå°†è‡ªåŠ¨è¿›è¡Œã€‚

      - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–è½¯ä»¶åŒ…
        id: download-dl
        run: |
          cd openwrt
          make defconfig
          make download -j$(($(nproc)+1))
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          make download -j$(($(nproc)+1))

      - name: å¼€å¯ç¼“å­˜
        uses: stupidloud/cachewrtbuild@main
        with:
          ccache: 'true'
            # å¯ç”¨ ccache ç¼“å­˜
          mixkey: ${{ matrix.version }}-${{ matrix.target }}
            # å®šä¹‰ç¼“å­˜æ ‡è¯†
          clean: ${{ contains(github.event.action, 'nocache') }}
          prefix: ${{ github.workspace }}/openwrt
            # æŒ‡å®šæºç æ ¹ç›®å½•è·¯å¾„

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: ç¼–è¯‘å·¥å…·é“¾
        id: mktools
        run: |
          cd openwrt
          make defconfig
          echo -e "$(($(nproc)+1)) thread compile"

          compile_with_fallback() {
            local target=$1

            if ! make $target -j$(($(nproc)+1)); then
              echo "å¤šçº¿ç¨‹ç¼–è¯‘ $target å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘"
              if ! make $target -j1 V=s; then
                echo "$target ç¼–è¯‘å¤±è´¥"
                return 1
              fi
            fi
            return 0
          }

          if ! compile_with_fallback "tools/compile"; then
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if ! compile_with_fallback "toolchain/compile"; then
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: æ¸…é™¤å·¥å…·é“¾ç¼–è¯‘ä¸­é—´äº§ç‰©
        if: steps.mktools.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt
          rm -rf dl/*
          rm -rf build_dir/host/*
          rm -rf build_dir/toolchain-*

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: ç¼–è¯‘å†…æ ¸
        id: mkkernel
        if: steps.mktools.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt
          echo -e "$(($(nproc)+1)) thread compile"
          if make target/linux/compile -j$(($(nproc)+1)) || make target/linux/compile -j1 V=s; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "å†…æ ¸ç¼–è¯‘æˆåŠŸ"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "å†…æ ¸ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: ç¼–è¯‘æ’ä»¶
        id: mkpackage
        if: steps.mkkernel.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt
          echo -e "$(($(nproc)+1)) thread compile"
          # ç¼–è¯‘æ’ä»¶åŒ…
          if make package/compile -j$(($(nproc)+1)) || make package/compile -j1 V=s; then
            # ç”ŸæˆåŒ…ç´¢å¼•
            make package/index
            # å®‰è£…æ’ä»¶åŒ…
            if make package/install -j$(nproc) || make package/install -j1 V=s; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "æ’ä»¶ç¼–è¯‘å’Œå®‰è£…æˆåŠŸ"
            else
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "æ’ä»¶å®‰è£…å¤±è´¥"
            exit 1
            fi
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "æ’ä»¶ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: æ¸…é™¤æ’ä»¶ç¼–è¯‘æ–‡ä»¶
        id: clpackage
        if: steps.mkpackage.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt
          rm -rf build_dir/target-*/host
          echo "status=success" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        if: steps.clpackage.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt
          echo -e "$(($(nproc)+1)) thread compile"
          if make target/install -j$(nproc) || make target/install -j1 V=s; then
            # ç¼–è¯‘æˆåŠŸåæå–è®¾å¤‡åç§°å’Œè®¾ç½®æ—¶é—´æˆ³
            grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/^CONFIG_TARGET_(.*)_DEVICE_(.*)=y/\1-\2/'  > DEVICE_NAME
            [ -s DEVICE_NAME ] && echo "DEVICE_NAME=$(cat DEVICE_NAME)" >> $GITHUB_ENV
            echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
            echo "å›ºä»¶ç¼–è¯‘æˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "å›ºä»¶ç¼–è¯‘å¤±è´¥"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶å¤¹
        working-directory: /workdir
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          mkdir -p firmware
            # åˆ›å»ºå›ºä»¶å­˜æ”¾ç›®å½•
          cd openwrt/bin/targets/*/*/
            # è¿›å…¥å›ºä»¶è¾“å‡ºç›®å½•
          TARGET_PLATFORM=$(basename $(dirname $(pwd)))
            # æå–ç›®æ ‡å¹³å°ä¿¡æ¯
          echo "å½“å‰ç›®æ ‡å¹³å°: $TARGET_PLATFORM"     

          shopt -s nullglob    
            # å¯ç”¨é€šé…ç¬¦ç©ºåŒ¹é…å¤„ç†
          shopt -s nocasematch 
            # å¯ç”¨ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
          
          if [[ "$TARGET_PLATFORM" == x86* ]]; then
            for file in *combined* *sysupgrade*; do
            [ -f "$file" ] && mv "$file" "/workdir/firmware/${{ matrix.version }}_$file"
            done
              # X86å¹³å°ï¼šä¿å­˜æ–‡ä»¶åä¸­åŒ…å« combined æˆ– sysupgrade åçš„æ–‡ä»¶è‡³firmwareæ–‡ä»¶å¤¹
          else
            for file in *squashfs*.bin; do
            [ -f "$file" ] && mv "$file" "/workdir/firmware/${{ matrix.version }}_$file"
              # å…¶ä»–å¹³å°ï¼šåªä¿å­˜sysupgrade.binåŠfactory.binæ ¼å¼
            done
          fi
          
          cd /workdir/firmware
          INFO_FILE="${{ matrix.version }}_${{matrix.target}}_build-info.txt"
          printf "ç‰ˆæœ¬: ${{ matrix.version }}\nç›®æ ‡è®¾å¤‡: ${{ matrix.target }}\næ„å»ºæ—¶é—´: $(date)\n\næ–‡ä»¶MD5æ ¡éªŒå’Œ:\n" > "$INFO_FILE"
          # æ·»åŠ MD5æ ¡éªŒå’Œ
          for file in *; do
            if [ -f "$file" ] && [ "$file" != "$INFO_FILE" ]; then
              md5=$(md5sum "$file" | awk '{print $1}')
              echo "$md5  $file" >> "$INFO_FILE"
            fi
          done
          
          #å¤åˆ¶é…ç½®æ–‡ä»¶
          cp /workdir/openwrt/.config  ./${{ matrix.version }}_${{matrix.target}}.config 2>/dev/null || true
          #æ·»åŠ ç‰ˆæœ¬ã€è®¾å¤‡ã€æ„å»ºæ—¶é—´ä¿¡æ¯
          
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
            #å°†å½“å‰ç›®å½•ï¼ˆå›ºä»¶å­˜æ”¾ç›®å½•ï¼‰è·¯å¾„å†™å…¥ç¯å¢ƒå˜é‡FIRMWARE
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: firmware-${{ matrix.version }}_${{ matrix.target }}_${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: ä¿å­˜ç‰ˆæœ¬å’Œç›®æ ‡ä¿¡æ¯
        working-directory: /workdir
        if: steps.organize.outputs.status == 'success'
        run: |
          echo "${{ matrix.version }}:${{ env.DEVICE_NAME }}" >> version_target_${{ matrix.version }}_${{ matrix.target }}.txt

      - name: ä¸Šä¼ ç‰ˆæœ¬ä¿¡æ¯
        uses: actions/upload-artifact@v4
        with:
          name: version_info_${{ matrix.version }}_${{ matrix.target }}
          path: /workdir/version_target_${{ matrix.version }}_${{ matrix.target }}.txt

      - name: è®¾ç½®ä½œä¸šè¾“å‡º
        id: set-outputs
        run: |
          echo "upload_release=${{ env.UPLOAD_RELEASE }}" >> $GITHUB_OUTPUT

  release-all:
    name: åˆå¹¶å‘å¸ƒæ‰€æœ‰å›ºä»¶
    runs-on: ubuntu-latest
    needs: build
    if: |
      ${{ 
        always() && 
        !cancelled() && 
        contains(join(needs.build.*.result, ','), 'success')  && 
        needs.build.outputs.upload_release == 'true' 
      }}

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: all-firmwares


      - name: ä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯
        uses: actions/download-artifact@v4
        with:
          path: version-info-all
          pattern: version_info*

      - name: æå–ç‰ˆæœ¬å’Œç›®æ ‡ä¿¡æ¯
        id: extract_version_target
        run: |
          # åˆ›å»ºåˆå¹¶åçš„ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "æ‰€æœ‰ç‰ˆæœ¬å’Œç›®æ ‡è®¾å¤‡ä¿¡æ¯æ±‡æ€»" > version-info-all.txt
          echo "==========================================" >> version-info-all.txt
          
          VERSIONS=()
          TARGETS=()
          
          # éå†æ‰€æœ‰ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶å¹¶åˆå¹¶å†…å®¹
          for file in $(find version-info-all -type f -name "version_target_*.txt"); do
            if [ -f "$file" ]; then
              # å°†å•ä¸ªæ–‡ä»¶å†…å®¹è¿½åŠ åˆ°åˆå¹¶æ–‡ä»¶
              cat "$file" >> version-info-all.txt
              echo "==========================================" >> version-info-all.txt
              # æå–ç‰ˆæœ¬å’Œç›®æ ‡è®¾å¤‡ä¿¡æ¯ç”¨äºåç»­å¤„ç†
              while IFS= read -r line; do
                IFS=':' read -ra parts <<< "$line"
                VERSIONS+=("${parts[0]}")
                TARGETS+=("${parts[1]}")
              done < "$file"
            fi
          done
          
          # å»é‡å¤„ç†
          UNIQUE_VERSIONS=($(printf "%s\n" "${VERSIONS[@]}" | sort -u))
          UNIQUE_TARGETS=($(printf "%s\n" "${TARGETS[@]}" | sort -u))
          # è¾“å‡ºåˆ°æ­¥éª¤å˜é‡
          echo "versions=${UNIQUE_VERSIONS[*]}" >> $GITHUB_OUTPUT
          echo "targets=${UNIQUE_TARGETS[*]}" >> $GITHUB_OUTPUT

      - name: æ•´ç†åˆå¹¶å›ºä»¶
        run: |
          mkdir -p final-release
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°ç»Ÿä¸€ç›®å½•
          find all-firmwares -type f -exec cp {} final-release/ \;
          
          # åˆ é™¤final-releaseç›®å½•ä¸­çš„version_target_*.txtæ–‡ä»¶
          find final-release -type f -name "version_target_*.txt" -delete
          
          # åˆå¹¶æ‰€æœ‰ä¿¡æ¯æ–‡ä»¶ä¸ºç»Ÿä¸€çš„ all-build-info.txt
          echo "# æ‰€æœ‰å›ºä»¶è¯¦ç»†ä¿¡æ¯" > final-release/all-build-info.txt
          echo "==========================================" >> final-release/all-build-info.txt
          # éå†æ‰€æœ‰ä¿¡æ¯æ–‡ä»¶å¹¶è¿½åŠ å†…å®¹
          for info_file in $(find all-firmwares -type f -name "*build-info.txt" | grep -v "all-build-info.txt"); do
            if [ -f "$info_file" ]; then
              echo -e "\n$(cat "$info_file")" >> final-release/all-build-info.txt
              echo "==========================================" >> final-release/all-build-info.txt
            fi
          done
          # åˆ é™¤é™¤all-build-info.txtå¤–çš„å…¶ä»–build-info.txtæ–‡ä»¶
          find final-release -type f -name "*build-info.txt" -not -name "all-build-info.txt" -delete
          
          #ç”Ÿæˆreleaseæ ‡é¢˜
          echo "# OpenWRT å›ºä»¶æ±‡æ€»å‘å¸ƒ" > release.txt
          echo "å‘å¸ƒæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> release.txt
          echo "åŒ…å«ä»¥ä¸‹ç‰ˆæœ¬å’Œè®¾å¤‡çš„å›ºä»¶ï¼š" >> release.txt
          echo "- ç‰ˆæœ¬: ${{ steps.extract_version_target.outputs.versions }}" >> release.txt
          echo "- è®¾å¤‡: ${{ steps.extract_version_target.outputs.targets }}" >> release.txt
          echo -e "\nå„å›ºä»¶è¯¦ç»†ä¿¡æ¯åŠMD5è¯·æŸ¥çœ‹ all-build-info.txt æ–‡ä»¶" >> release.txt
          echo -e "\nğŸŒ é»˜è®¤ç®¡ç†IP: 192.168.123.1" >> release.txt

      - name: ç”Ÿæˆç»Ÿä¸€å‘å¸ƒæ ‡ç­¾
        id: tag
        run: |
          echo "release_tag=openwrt-all-firmwares_$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒåˆå¹¶åçš„Release
        uses: softprops/action-gh-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: final-release/*

      - name: ä¿ç•™æœ€æ–°3ä¸ªRelease
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ é™¤æ—§çš„å·¥ä½œæµç¨‹
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 3
